<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>T9 OS Chat</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{height:100vh;display:flex;background:linear-gradient(135deg,#0a0e27 0%,#1a1f3a 100%);color:#e8eaf6;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;overflow:hidden}
  
  .sidebar{width:280px;background:rgba(15,20,40,0.95);backdrop-filter:blur(10px);border-right:1px solid rgba(100,150,255,0.1);padding:20px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;flex-shrink:0}
  .sidebar::-webkit-scrollbar{width:6px}
  .sidebar::-webkit-scrollbar-track{background:transparent}
  .sidebar::-webkit-scrollbar-thumb{background:rgba(100,150,255,0.3);border-radius:3px}
  .section-title{color:#6b9fff;font-size:.7rem;margin-top:12px;margin-bottom:4px;text-transform:uppercase;letter-spacing:1.5px;font-weight:600}
  .sidebar-item{padding:12px 14px;background:rgba(30,40,70,0.6);border-radius:10px;cursor:pointer;transition:all 0.2s ease;border:1px solid transparent;font-size:.95rem}
  .sidebar-item:hover{background:rgba(50,70,120,0.7);border-color:rgba(100,150,255,0.2);transform:translateX(2px)}
  .sidebar-item.active{background:linear-gradient(135deg,#4e8cff 0%,#3a6fd9 100%);border-color:rgba(100,150,255,0.3);box-shadow:0 2px 8px rgba(78,140,255,0.3)}
  
  .chat-area{flex:1;display:flex;flex-direction:column;background:rgba(10,15,30,0.5);min-width:0;position:relative}
  
  .chat-header{padding:18px 24px;background:rgba(15,25,50,0.8);backdrop-filter:blur(10px);border-bottom:1px solid rgba(100,150,255,0.15);font-size:1.15rem;color:#a8c5ff;font-weight:600;letter-spacing:0.3px;flex-shrink:0;display:flex;justify-content:space-between;align-items:center}
  .connection-status{font-size:0.75rem;color:#7ea8ff;display:flex;align-items:center;gap:6px}
  .status-dot{width:8px;height:8px;border-radius:50%;background:#4e8cff;animation:pulse 2s infinite}
  .status-dot.connecting{background:#ffa726}
  .status-dot.offline{background:#f44336;animation:none}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
  
  .messages{flex:1;overflow:auto;padding:24px;display:flex;flex-direction:column;gap:14px}
  .messages::-webkit-scrollbar{width:8px}
  .messages::-webkit-scrollbar-track{background:transparent}
  .messages::-webkit-scrollbar-thumb{background:rgba(100,150,255,0.3);border-radius:4px}
  .msg{max-width:65%;animation:slideIn 0.2s ease}
  @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .msg.own{align-self:flex-end}
  .msg-name{font-size:.75rem;color:#7ea8ff;margin-bottom:5px;font-weight:500}
  .msg-bubble{background:rgba(30,45,80,0.9);padding:12px 16px;border-radius:12px;color:#e8eaf6;box-shadow:0 2px 6px rgba(0,0,0,0.2);border:1px solid rgba(100,150,255,0.1);line-height:1.5}
  .msg.own .msg-bubble{background:linear-gradient(135deg,#4e8cff 0%,#5a98ff 100%);color:#fff;border-color:rgba(255,255,255,0.1)}
  .loading-indicator{text-align:center;color:#7ea8ff;opacity:0.7;padding:20px;font-size:0.9rem}

  .input-bar {
    display: flex;
    gap: 12px;
    padding: 16px 24px;
    background: rgba(15,25,50,0.9);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(100,150,255,0.15);
    flex-shrink: 0;
  }
  .input-bar input {
    flex: 1 1 auto;
    min-width: 0;
    padding: 14px 18px;
    border-radius: 24px;
    background: rgba(30,40,70,0.8);
    border: 1px solid rgba(100,150,255,0.2);
    color: #e8eaf6;
    font-size: .95rem;
    transition: all 0.2s ease;
  }
  .char-counter {
    position: absolute;
    bottom: 24px;
    right: 140px;
    font-size: 0.75rem;
    color: rgba(200,210,255,0.5);
    pointer-events: none;
  }
  .char-counter.warning {
    color: rgba(255,200,100,0.9);
    font-weight: 600;
  }
  .char-counter.error {
    color: rgba(255,100,100,0.9);
    font-weight: 600;
  }
  .input-bar input:focus {outline:none;border-color:rgba(100,150,255,0.5);background:rgba(30,40,70,1)}
  .input-bar input::placeholder{color:rgba(200,210,255,0.4)}
  .input-bar button {
    flex-shrink: 0;
    width: 100px;
    padding: 14px;
    border-radius: 24px;
    border: none;
    background: linear-gradient(135deg,#4e8cff 0%,#3a6fd9 100%);
    font-weight: 600;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .input-bar button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(78,140,255,0.4)}
  .input-bar button:active{transform:translateY(0)}
  .input-bar button:disabled{
    background: rgba(70,80,120,0.5);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:1000;animation:fadeIn 0.3s ease}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .modal{background:linear-gradient(135deg, rgba(15,25,50,0.98) 0%, rgba(20,30,60,0.98) 100%);border:1px solid rgba(100,150,255,0.3);border-radius:16px;padding:32px;min-width:360px;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:modalSlide 0.3s ease}
  @keyframes modalSlide{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
  .modal h2{color:#a8c5ff;margin-bottom:20px;text-align:center;font-size:1.4rem;font-weight:600}
  .modal input{width:100%;padding:14px 16px;border-radius:10px;border:1px solid rgba(100,150,255,0.3);background:rgba(30,40,70,0.8);color:#e8eaf6;margin-bottom:18px;font-size:.95rem;transition:all 0.2s ease}
  .modal input:focus{outline:none;border-color:rgba(100,150,255,0.6);background:rgba(30,40,70,1)}
  .modal input::placeholder{color:rgba(200,210,255,0.4)}
  .modal button{width:100%;padding:14px;background:linear-gradient(135deg,#4e8cff 0%,#3a6fd9 100%);border:none;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;font-size:1rem;transition:all 0.2s ease;box-shadow:0 4px 12px rgba(78,140,255,0.3)}
  .modal button:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(78,140,255,0.4)}
  .modal button:active{transform:translateY(0)}

  .warning-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(255, 50, 50, 0.95);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(255, 50, 50, 0.4);
    animation: slideInRight 0.3s ease;
    z-index: 2000;
    font-weight: 600;
  }
  @keyframes slideInRight{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
</style>
</head>
<body>

<div id="nameModal" class="modal-overlay">
  <div class="modal">
    <h2>Welcome to T9 OS Chat</h2>
    <input id="nameInput" placeholder="Enter your display name" maxlength="32" autocomplete="off" />
    <button id="nameSubmit">Join Chat</button>
  </div>
</div>

<div class="sidebar">
  <div class="section-title">Rooms</div>
  <div id="publicRoomBtn" class="sidebar-item active">üåç Public</div>
  <div id="createRoomBtn" class="sidebar-item">‚ûï Create Room</div>
  <div id="joinRoomBtn" class="sidebar-item">üîó Join Room</div>
  <div id="joinedRooms" class="sidebar-rooms" style="display:flex;flex-direction:column;gap:6px;margin-top:10px;"></div>
</div>

<div class="chat-area">
  <div class="chat-header">
    <span id="roomTitle">Public Chat</span>
    <div class="connection-status">
      <span class="status-dot connecting"></span>
      <span id="statusText">Connecting...</span>
    </div>
  </div>
  <div id="messages" class="messages">
    <div class="loading-indicator">Loading messages...</div>
  </div>
  <div class="input-bar">
    <input id="msgInput" placeholder="Type a message‚Ä¶" autocomplete="off" maxlength="600" />
    <span id="charCounter" class="char-counter">0/600</span>
    <button id="sendBtn">Send</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const OWNER_ID = "0635354315";
  const ID_KEY = "numericUserID";

  const banFirebaseConfig = {
    apiKey: "AIzaSyD74Fi2RKsvv1sXTAEIiTYrRKCv22MRhh8",
    authDomain: "t9oschat.firebaseapp.com",
    databaseURL: "https://t9oschat-default-rtdb.firebaseio.com",
    projectId: "t9oschat",
    storageBucket: "t9oschat.firebasestorage.app",
    messagingSenderId: "930534704832",
    appId: "1:930534704832:web:c154890c3b5f36736f8f25",
    measurementId: "G-STPKYT658F"
  };

  const banApp = firebase.initializeApp(banFirebaseConfig);
  const banDB = firebase.database(banApp);

  function generateNumericID() {
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    return random + timestamp;
  }

  (function() {
    'use strict';
    
    const originalSetItem = Storage.prototype.setItem;
    const originalRemoveItem = Storage.prototype.removeItem;
    const originalClear = Storage.prototype.clear;
    
    let isLocked = false;
    let myID = null;

    function lockScreen() {
      if (isLocked) return;
      isLocked = true;
      
      document.body.innerHTML = "";
      document.body.style.cssText = "background: red; color: white; display: flex; justify-content: center; align-items: center; font-size: 40px; overflow: hidden; margin: 0; height: 100vh;";
      document.body.innerText = "BANNED";

      const preventAll = (e) => {
        e.preventDefault();
        e.stopPropagation();
        return false;
      };
      
      ['keydown', 'keyup', 'keypress', 'mousedown', 'mouseup', 'click', 
       'touchstart', 'touchend', 'contextmenu', 'beforeunload'].forEach(event => {
        document.addEventListener(event, preventAll, true);
        window.addEventListener(event, preventAll, true);
      });

      Storage.prototype.setItem = function() { return; };
      Storage.prototype.removeItem = function() { return; };
      Storage.prototype.clear = function() { return; };
      
      Object.freeze(localStorage);
      Object.freeze(sessionStorage);
      
      window.onbeforeunload = () => true;
      history.pushState(null, null, location.href);
      window.onpopstate = () => history.go(1);
      
      window.banDB = null;
      window.firebase = null;
    }

    document.addEventListener("DOMContentLoaded", () => {
      myID = localStorage.getItem(ID_KEY);
      if (!myID) {
        myID = generateNumericID();
        originalSetItem.call(localStorage, ID_KEY, myID);
      }

      window.currentUserID = myID;
      window.banDatabase = banDB;

      const checkInterval = setInterval(() => {
        const currentID = localStorage.getItem(ID_KEY);
        if (currentID !== myID) {
          originalSetItem.call(localStorage, ID_KEY, myID);
        }
        
        if (isLocked) {
          lockScreen();
        }
      }, 100);

      const bannedRef = banDB.ref("bannedIDs");
      bannedRef.on("value", (snapshot) => {
        const bannedIDs = snapshot.val() || [];
        if (bannedIDs.includes(myID)) {
          lockScreen();
        }
      });

      document.addEventListener("keydown", async (e) => {
        if (myID !== OWNER_ID) return;
        if (e.key === ",") {
          const action = prompt("Type 'ban' to ban or 'unban' to unban:");
          if (!action) return;
          const targetID = prompt("Enter the ID to " + action + ":");
          if (!targetID) return;

          const snapshot = await bannedRef.get();
          let bannedIDs = snapshot.val() || [];

          if (action.toLowerCase() === "ban") {
            if (!bannedIDs.includes(targetID)) {
              bannedIDs.push(targetID);
              await bannedRef.set(bannedIDs);
              alert("User banned: " + targetID);
            } else {
              alert("User is already banned.");
            }
          } else if (action.toLowerCase() === "unban") {
            bannedIDs = bannedIDs.filter(id => id !== targetID);
            await bannedRef.set(bannedIDs);
            alert("User unbanned: " + targetID);
          } else {
            alert("Invalid action.");
          }
        }
      });
    });
  })();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, off, query, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD74Fi2RKsvv1sXTAEIiTYrRKCv22MRhh8",
  authDomain: "t9oschat.firebaseapp.com",
  databaseURL: "https://t9oschat-default-rtdb.firebaseio.com",
  projectId: "t9oschat",
  storageBucket: "t9oschat.firebasestorage.app",
  messagingSenderId: "930534704832",
  appId: "1:930534704832:web:c154890c3b5f36736f8f25",
  measurementId: "G-STPKYT658F"
};

const app = initializeApp(firebaseConfig, "chatApp");
const db = getDatabase(app);

const messagesEl = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const charCounter = document.getElementById('charCounter');
const roomTitle = document.getElementById('roomTitle');
const nameModal = document.getElementById('nameModal');
const nameInput = document.getElementById('nameInput');
const nameSubmit = document.getElementById('nameSubmit');
const publicRoomBtn = document.getElementById('publicRoomBtn');
const createRoomBtn = document.getElementById('createRoomBtn');
const joinRoomBtn = document.getElementById('joinRoomBtn');
const joinedRoomsEl = document.getElementById('joinedRooms');
const statusDot = document.querySelector('.status-dot');
const statusText = document.getElementById('statusText');

const ID_KEY = "numericUserID";
let myID = window.currentUserID || localStorage.getItem(ID_KEY);
let username = "Anonymous";
let currentRoom = "public";
let currentListener = null;
let violationCount = 0;
const MAX_VIOLATIONS = 3;
const MAX_CHARS = 600;
let lastMessageTime = 0;
const MESSAGE_COOLDOWN = 5000;
const MAX_MESSAGES = 50;
let isConnected = false;
let connectionTimeout = null;
let retryAttempts = 0;
const MAX_RETRY = 5;

// Connection monitoring
const connectedRef = ref(db, '.info/connected');
onValue(connectedRef, (snap) => {
  isConnected = snap.val() === true;
  updateConnectionStatus();
});

function updateConnectionStatus() {
  if (isConnected) {
    statusDot.className = 'status-dot';
    statusText.textContent = 'Connected';
    retryAttempts = 0;
  } else {
    statusDot.className = 'status-dot offline';
    statusText.textContent = 'Offline';
  }
}

const profanityPatterns = [
  /n+[i1!|]+[gq9]+[e3a@]+r+/gi,
  /n+[i1!|]+[gq9]+[ae@3]+/gi,
  /n[i1!|]+b+[b8]+[ae@3]+/gi,
  /\bf+[\s\.\-_]*u+[\s\.\-_]*c+[\s\.\-_]*k+\b/gi,
  /\bf+[\s\.\-_]*[u@]+[\s\.\-_]*[c(<]+[\s\.\-_]*[k|!]+\b/gi,
  /\bph+u+c+k+\b/gi,
  /\bs+[\s\.\-_]*h+[\s\.\-_]*[i1!]+[\s\.\-_]*t+\b/gi,
  /\bb+[\s\.\-_]*[i1!]+[\s\.\-_]*t+[\s\.\-_]*c+[\s\.\-_]*h+\b/gi,
  /\bd+[\s\.\-_]*a+[\s\.\-_]*m+[\s\.\-_]*n+\b/gi,
  /\bh+[\s\.\-_]*e+[\s\.\-_]*l+[\s\.\-_]*l+\b/gi,
  /\bc+[\s\.\-_]*r+[\s\.\-_]*a+[\s\.\-_]*p+\b/gi,
  /\bp+[\s\.\-_]*i+[\s\.\-_]*s+[\s\.\-_]*s+\b/gi,
  /\bf+[\s\.\-_]*a+[\s\.\-_]*g+\b/gi,
  /\bf+[\s\.\-_]*[a@4]+[\s\.\-_]*[gq9]+[o0]*[t+]*\b/gi,
  /ch+[i1!]+n+k+/gi,
  /sp+[i1!]+c+/gi,
  /w+[e3]+t+b+[a@]+c+k+/gi,
  /[f‚Ç£∆í]+[u_¬µ]+[c¬¢]+[k|<]+/gi,
  /[b8]+[i!1|]+[t+]+[c¬¢(<]+[h#]+/gi,
  /[s$5]+[h#]+[i!1|]+[t+]/gi,
  /[\u0192\uff46]+[\u03bc\uff55]+[\u00a2\uff43]+[\uff4b]/gi
];

function normalizeText(text) {
  let normalized = text.toLowerCase()
    .replace(/[\s\.\-_]/g, '')
    .replace(/[0]/g, 'o')
    .replace(/[1]/g, 'i')
    .replace(/[3]/g, 'e')
    .replace(/[4]/g, 'a')
    .replace(/[5]/g, 's')
    .replace(/[7]/g, 't')
    .replace(/[8]/g, 'b')
    .replace(/[9]/g, 'g')
    .replace(/[@]/g, 'a')
    .replace(/[!|]/g, 'i')
    .replace(/[$]/g, 's')
    .replace(/[+]/g, 't');
  
  return normalized;
}

function containsProfanity(text) {
  for (let pattern of profanityPatterns) {
    if (pattern.test(text)) {
      return true;
    }
  }
  
  const normalized = normalizeText(text);
  const simplePatterns = [
    'fuck', 'shit', 'bitch', 'damn', 'hell', 'crap', 'piss',
    'nigger', 'nigga', 'fag', 'faggot', 'chink', 'spic', 'wetback',
    'niger', 'niga', 'nibba'
  ];
  
  for (let word of simplePatterns) {
    if (normalized.includes(word)) {
      return true;
    }
  }
  
  return false;
}

function showWarning(message) {
  const toast = document.createElement('div');
  toast.className = 'warning-toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideInRight 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

async function handleViolation() {
  violationCount++;
  
  if (violationCount >= MAX_VIOLATIONS) {
    showWarning(`You have been banned for ${MAX_VIOLATIONS} chat filter violations.`);
    
    const bannedRef = window.banDatabase.ref("bannedIDs");
    const snapshot = await bannedRef.get();
    let bannedIDs = snapshot.val() || [];
    
    if (!bannedIDs.includes(myID)) {
      bannedIDs.push(myID);
      await bannedRef.set(bannedIDs);
    }
    
    setTimeout(() => {
      location.reload();
    }, 2000);
  } else {
    showWarning(`Warning ${violationCount}/${MAX_VIOLATIONS}: Inappropriate language detected. ${MAX_VIOLATIONS - violationCount} warnings remaining.`);
  }
}

function escapeHtml(s){ return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

function appendMessage(payload, skipOwn=false){
  if(skipOwn && payload.id===myID) return;
  
  const loadingIndicator = messagesEl.querySelector('.loading-indicator');
  if (loadingIndicator) {
    loadingIndicator.remove();
  }
  
  const div = document.createElement('div');
  div.className = 'msg' + ((payload.id === myID) ? ' own' : '');
  const displayName = (payload.name && payload.id) ? `${payload.name} (${payload.id})` : (payload.name || `Anon (${payload.id || 'unknown'})`);
  div.innerHTML = `<div class="msg-name">${escapeHtml(displayName)}</div>
                   <div class="msg-bubble">${escapeHtml(payload.text)}</div>`;
  messagesEl.appendChild(div);
  
  const messages = messagesEl.children;
  if(messages.length > MAX_MESSAGES){
    messages[0].remove();
  }
  
  const isNearBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < 150;
  if(isNearBottom){
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
}

function clearMessages(){ 
  messagesEl.innerHTML='<div class="loading-indicator">Loading messages...</div>'; 
}

function loadMessages(room){
  if(currentListener) {
    off(currentListener);
  }
  clearMessages();
  
  statusDot.className = 'status-dot connecting';
  statusText.textContent = 'Loading...';
  
  const messagesRef = ref(db, "messages/" + room);
  const limitedQuery = query(messagesRef, limitToLast(30));
  currentListener = messagesRef;
  
  let messageCount = 0;
  const loadTimeout = setTimeout(() => {
    if (messageCount === 0) {
      const loadingIndicator = messagesEl.querySelector('.loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.textContent = 'No messages yet. Be the first to send one!';
      }
      updateConnectionStatus();
    }
  }, 5000);
  
  onChildAdded(limitedQuery, snap=>{
    const m = snap.val();
    if(!m) return;
    messageCount++;
    clearTimeout(loadTimeout);
    appendMessage(m, false);
    updateConnectionStatus();
  }, (error) => {
    console.error('Firebase error:', error);
    showWarning('Failed to load messages. Check your connection.');
    statusDot.className = 'status-dot offline';
    statusText.textContent = 'Error';
  });
}

async function sendMessage(){
  const txt = msgInput.value.trim();
  if(!txt) return;
  
  if (!isConnected) {
    showWarning('You are offline. Check your internet connection.');
    return;
  }
  
  const now = Date.now();
  const timeLeft = MESSAGE_COOLDOWN - (now - lastMessageTime);
  if (timeLeft > 0) {
    showWarning(`Please wait ${Math.ceil(timeLeft / 1000)} seconds before sending another message.`);
    return;
  }
  
  if (txt.length > MAX_CHARS) {
    showWarning(`Message too long! Maximum ${MAX_CHARS} characters.`);
    return;
  }
  
  if (containsProfanity(txt)) {
    msgInput.value = '';
    updateCharCounter();
    await handleViolation();
    return;
  }
  
  sendBtn.disabled = true;
  statusDot.className = 'status-dot connecting';
  statusText.textContent = 'Sending...';
  
  const messagePayload = {name: username, id: myID, text: txt, timestamp: Date.now()};
  
  try {
    await push(ref(db, "messages/" + currentRoom), messagePayload);
    msgInput.value = '';
    updateCharCounter();
    lastMessageTime = now;
    updateConnectionStatus();
    
    setTimeout(() => {
      sendBtn.disabled = false;
    }, MESSAGE_COOLDOWN);
    
  } catch (error) {
    console.error('Error sending message:', error);
    showWarning('Failed to send message. Check your connection and try again.');
    sendBtn.disabled = false;
    updateConnectionStatus();
  }
}

function updateCharCounter() {
  const length = msgInput.value.length;
  charCounter.textContent = `${length}/${MAX_CHARS}`;
  
  charCounter.classList.remove('warning', 'error');
  if (length > MAX_CHARS * 0.9) {
    charCounter.classList.add('error');
  } else if (length > MAX_CHARS * 0.75) {
    charCounter.classList.add('warning');
  }
}

msgInput.addEventListener('input', updateCharCounter);
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

function handleNameSubmit(e){
  if(e) e.preventDefault();
  const name = nameInput.value.trim();
  if(!name){ alert('Enter a display name'); return; }
  
  if (containsProfanity(name)) {
    alert('Your display name contains inappropriate language. Please choose another name.');
    return;
  }
  
  username = name.substring(0,32);
  nameModal.remove();
  loadMessages(currentRoom);
}

nameSubmit.addEventListener('click', handleNameSubmit);
nameInput.addEventListener('keydown', e=>{ if(e.key==='Enter') handleNameSubmit(e); });
setTimeout(()=>nameInput.focus(),100);

let joinedRooms = new Set(['public']);

function refreshJoinedRoomsUI(){
  joinedRoomsEl.innerHTML = '';
  joinedRooms.forEach(room=>{
    if(room==='public') return;
    const div = document.createElement('div');
    div.className='sidebar-item';
    div.innerText=room;
    div.addEventListener('click', ()=>{ switchRoom(room); });
    joinedRoomsEl.appendChild(div);
  });
}

function switchRoom(room){
  currentRoom = room;
  roomTitle.innerText = room==='public' ? 'Public Chat' : room;
  loadMessages(currentRoom);
  Array.from(document.querySelectorAll('.sidebar-item')).forEach(el=>el.classList.remove('active'));
  if(room==='public'){ publicRoomBtn.classList.add('active'); }
  else{ Array.from(joinedRoomsEl.children).forEach(el=>{ if(el.innerText===room) el.classList.add('active'); }); }
}

publicRoomBtn.addEventListener('click', ()=>{ switchRoom('public'); });
createRoomBtn.addEventListener('click', ()=>{
  const room = prompt("Enter new room name:")?.trim();
  if(!room) return;
  if (containsProfanity(room)) {
    alert('Room name contains inappropriate language.');
    return;
  }
  joinedRooms.add(room);
  refreshJoinedRoomsUI();
  switchRoom(room);
});
joinRoomBtn.addEventListener('click', ()=>{
  const room = prompt("Enter room name to join:")?.trim();
  if(!room) return;
  joinedRooms.add(room);
  refreshJoinedRoomsUI();
  switchRoom(room);
});
</script>
</body>
</html>
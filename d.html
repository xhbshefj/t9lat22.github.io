<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T9 Browser</title>

<!-- Ultraviolet -->
<script src="/uv/uv.bundle.js"></script>
<script src="/uv/uv.config.js"></script>
<script src="/baremux/index.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; font-family: Inter, system-ui; }

html, body {
    margin: 0;
    width: 100%;
    height: 100%;
    background: #1e1e1e;
    overflow: hidden;
}

/* ===== TOP UI ===== */
.browser-ui {
    height: 96px;
    background: #2b2b2b;
    display: flex;
    flex-direction: column;
    border-bottom: 1px solid #111;
}

.tabs {
    height: 38px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0 8px;
    overflow-x: auto;
}

.tab {
    height: 28px;
    min-width: 160px;
    max-width: 220px;
    padding: 0 12px;
    border-radius: 8px 8px 0 0;
    background: #3a3a3a;
    color: #ddd;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.tab.active {
    background: #1e1e1e;
    color: white;
}

.tab span {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.tab i {
    opacity: .6;
}
.tab i:hover {
    opacity: 1;
    color: #ff6b6b;
}

.newtab {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: #aaa;
    cursor: pointer;
}
.newtab:hover { background: #444; }

.navbar {
    height: 58px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0 12px;
}

.navbar button {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    border: none;
    background: transparent;
    color: #bbb;
    cursor: pointer;
}
.navbar button:hover {
    background: #3a3a3a;
    color: white;
}

.urlbar {
    flex: 1;
    height: 36px;
    background: #3a3a3a;
    border-radius: 18px;
    padding: 0 16px;
    display: flex;
    align-items: center;
}

.urlbar input {
    width: 100%;
    background: transparent;
    border: none;
    outline: none;
    color: white;
}

/* ===== VIEW ===== */
.viewframe {
    position: absolute;
    top: 96px;
    left: 0;
    width: 100%;
    height: calc(100% - 96px);
    border: none;
    display: none;
}

.viewframe.active {
    display: block;
}

.ntp {
    position: absolute;
    top: 96px;
    left: 0;
    width: 100%;
    height: calc(100% - 96px);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
</style>
</head>

<body>

<div class="browser-ui">
    <div class="tabs" id="tabs">
        <button class="newtab" id="newtab"><i class="fas fa-plus"></i></button>
    </div>

    <div class="navbar">
        <button id="back"><i class="fas fa-arrow-left"></i></button>
        <button id="forward"><i class="fas fa-arrow-right"></i></button>
        <button id="reload"><i class="fas fa-rotate-right"></i></button>

        <form class="urlbar" id="form">
            <input id="url" placeholder="Search or enter address">
        </form>

        <button id="popout"><i class="fas fa-external-link"></i></button>
    </div>
</div>

<div class="ntp" id="ntp">
    <h1>Loading | T9 Browser</h1>
</div>

<script>
/* ===== UV + BAREMUX ===== */
navigator.serviceWorker?.register("/uv/sw.js")

const connection = new BareMux.BareMuxConnection("/baremux/worker.js")
connection.setTransport("/libcurl/index.mjs", [{ websocket: "wss://wisp.rhw.one/" }])

async function waitForUVReady() {
    if ("serviceWorker" in navigator) {
        await navigator.serviceWorker.ready
    }
    let tries = 0
    while (!connection.transport && tries < 20) {
        await new Promise(r => setTimeout(r, 150))
        tries++
    }
    await new Promise(r => setTimeout(r, 300))
}

/* ===== TAB SYSTEM ===== */
const tabsEl = document.getElementById("tabs")
const newTabBtn = document.getElementById("newtab")
const urlInput = document.getElementById("url")
const ntp = document.getElementById("ntp")

let tabs = []
let activeId = null
let idCounter = 0

function createTab(url = "") {
    const id = idCounter++

    const iframe = document.createElement("iframe")
    iframe.className = "viewframe"
    iframe.dataset.id = id
    iframe.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-modals allow-popups")
    document.body.appendChild(iframe)

    const tabBtn = document.createElement("div")
    tabBtn.className = "tab"
    tabBtn.dataset.id = id
    tabBtn.innerHTML = `<span>New Tab</span><i class="fas fa-xmark"></i>`

    tabBtn.onclick = e => {
        if (e.target.tagName === "I") closeTab(id)
        else activateTab(id)
    }

    tabsEl.insertBefore(tabBtn, newTabBtn)
    tabs.push({ id, iframe, tabBtn, history: [], index: -1 })
    activateTab(id)

    if (url) navigate(url)
}

function activateTab(id) {
    activeId = id
    tabs.forEach(t => {
        t.iframe.classList.toggle("active", t.id === id)
        t.tabBtn.classList.toggle("active", t.id === id)
    })
}

function closeTab(id) {
    if (tabs.length === 1) return
    const i = tabs.findIndex(t => t.id === id)
    if (i === -1) return
    tabs[i].iframe.remove()
    tabs[i].tabBtn.remove()
    tabs.splice(i,1)
    activateTab(tabs[Math.max(0,i-1)].id)
}

function getTab() {
    return tabs.find(t => t.id === activeId)
}

/* ===== NAVIGATION ===== */
function normalize(input) {
    if (!input.includes(".")) return "https://search.brave.com/search?q=" + encodeURIComponent(input)
    if (!input.startsWith("http")) return "https://" + input
    return input
}

function navigate(input, push = true) {
    const tab = getTab()
    if (!tab) return

    const url = normalize(input)
    if (push) {
        tab.history = tab.history.slice(0, tab.index+1)
        tab.history.push(url)
        tab.index++
    }

    const encoded = __uv$config.prefix + __uv$config.encodeUrl(url)
    let retries = 0

    const load = () => tab.iframe.src = encoded

    tab.iframe.onload = () => {
        try {
            const txt = tab.iframe.contentDocument?.body?.innerText || ""
            if (txt.includes("Ultraviolet") && retries < 2) {
                retries++
                setTimeout(load, 600)
            }
        } catch {}
    }

    load()
    urlInput.value = url
    ntp.style.display = "none"
}

/* ===== CONTROLS ===== */
back.onclick = () => { const t=getTab(); if(t?.index>0){t.index--;navigate(t.history[t.index],false)} }
forward.onclick = () => { const t=getTab(); if(t && t.index<t.history.length-1){t.index++;navigate(t.history[t.index],false)} }
reload.onclick = () => { const t=getTab(); if(t) t.iframe.src=t.iframe.src }
popout.onclick = () => { const t=getTab(); if(t) window.open(t.iframe.src) }
form.onsubmit = e => { e.preventDefault(); if(urlInput.value) navigate(urlInput.value) }
newTabBtn.onclick = () => createTab()

/* ===== START DISCORD SAFELY ===== */
;(async () => {
    await waitForUVReady()
    createTab("https://discord.com")
})()
</script>

</body>
</html>
